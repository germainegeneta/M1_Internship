---
title: "Standardizing datasets to DarwinCore format ver. 3 revision 2"
author: "Germaine Comia Geneta"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidyr)
library(dplyr)
library(countrycode)
library(sf)
```

# Setting up

Throughout the transformation, we will only use the VectAbundance dataset (https://zenodo.org/records/11486198) from Da Re et al. (2024) as a sample dataset. After loading our data, denoted by `r data`, we must check the fields that we have. To be organized when saving and exporting datasets into csv files, we will name each dataset using `r datasetName`. This will appear as a field later in the record-level metadataset.

```{r paged.print=TRUE}
# Load your data
data <- read_csv("vect_trial.csv")

# Check data
head(data, n = 5)

# Set the dataset name
datasetName <- "VectAbundance_2024"
```

# Sampling-event: Transforming datasets to sampling-event DarwinCore format
*Required DwC fields:*

- eventID 
- eventDate
- samplingProtocol
- samplingSizeValue
- samplingSizeUnit

*Strongly recommended DwC fields*

- countryCode	 
- parentEventID	 
- samplingEffort	 
- locationID	 
- decimalLatitude 
- decimalLongitude 
- geodeticDatum	 
- coordinateUncertaintyInMeters	or coordinatePrecision
- footprintWKT	 
- occurrenceStatus

However for these datasets, we will be using the following fields in combination with additional fields for easier data manipulation:

- eventID
- eventDate: as an interval/range
- year
- month
- samplingProtocol
- samplingSizeUnit: for harmonization, should be in days
- samplingSizeValue
- countryCode
- samplingEffort
- decimalLatitude 
- decimalLongitude 
- geodeticDatum	 
- coordinatePrecision
- footprintWKT: when available or applicable
- habitat: e.g. urban, peri-urban, rural, etc.; when available
- continent
- country
- stateProvince: also the region
- municipality
- institutionCode
- eventRemarks: to document differences in the ovitrap used by each organisms (sections 'Ovitraps characteristics' in the paper)

## Data review
Inspect the original dataset to ensure the presence and completeness of the fields required by the DwC standard.

## Column mapping and assignment
Identify the columns in the original dataset corresponding to each DwC field. Create objects in preparation for the new columns in the new dataframe, assigning values from the original dataset to the corresponding DwC fields. Ideally, we will only alter the contents of this section of the script and run the next section as is.
```{r}
# eventID
eventID <- data$ID

# eventDate
eventDate <- paste0(
  as.Date(data$date, format = "%d/%m/%y"),
  "/",
  as.Date(data$date, format = "%d/%m/%y") + 7)

# year
year <- format(data$date, "%Y")

# month
month <- format(data$date, "%B")

# samplingProtocol
samplingProtocol <- data$trap_type

# samplingSizeUnit
samplingSizeUnit <- "days"

#samplingSizeValue
samplingSizeValue <- 7 

# countryCode
countryCode <- data$Country  

# samplingEffort
samplingEffort <- data |>
  transmute(
    samplingEffort = case_when(
      Region %in% c("Fier",
                    "Vlore",
                    "Tirane",
                    "Sicily") ~ "1 week of ovitrap laying",
      Region %in% c("Lushnje",
                    "Lezhe",
                    "Cote Azur",
                    "Autonomous Province of Trento",
                    "Emilia-Romagna",
                    "Veneto",
                    "Canton of Ticino") ~ "2 weeks of ovitrap laying downscaled to 1 week in post-processing", #Note: Kavaje (Tirane) biweekly inspection
      Region %in% c("Puglia") ~ "every 7-10 days inspection",
      Region == "Lazio" & year == 2017 ~ "1 week of ovitrap laying",
      Region == "Lazio" & year != 2017 ~ " 2 weeks of ovitrap laying downscaled to 1 week in post-processing",
      Region == "Tuscany" & year == 2020 ~ "1 week of ovitrap laying",
      Region == "Tuscany" & year != 2020 ~ "2 weeks of ovitrap laying downscaled to 1 week in post-processing",
      TRUE ~ NA_character_  # default for others
    )
  ) |>
  pull(samplingEffort)

# decimalLatitude
decimalLatitude <- data$latitude

# decimalLongitude
decimalLongitude <- data$longitude

#geodeticDatum
geodeticDatum <- paste("EPSG", data$EPSG, sep = ":")

# coordinatePrecision
coordinatePrecision <- 0.1

# footprintWKT
footprintWKT <- NA

# habitat
habitat <- data |>
  transmute(
    habitat = case_when(
      Region %in% c("Lazio", "Tuscany", "Veneto") ~ "urban, outdoors",
      TRUE ~ "unknown"  # default for others
    )
  ) |>
  pull(habitat)

# continent
continent <- data$Country

# country
country <- data$Country

# stateProvince
stateProvince <- data$Region

# municipality - not explicitly stated in dataset (stated in paper but aggregated in dataset)
municipality <- NA

# institutionCode (in this dataset : the column Institute)
unique(data$Institute) # to get the unique institute names
institutionCode <- data |>
  transmute(
    institutionCode = case_when(
      Institute %in% c("Istituto Zooprofilattico Sperimentale delle Venezie") ~ "IZSVe",
      Institute %in% c("SUPSI-DACD-IM-ECOVET") ~ "SUPSI",
      Institute %in% c("Emilia-Romagna Region") ~ "EM",
      Institute %in% c("Istituto Zooprofilattico Sperimentale Lazio-Toscana") ~ "IZSLT",
      Institute %in% c("EID Mediterranee") ~ "EID_MED",
      Institute %in% c("Institute of Public Health Tirana") ~ "ISHP",
      Institute %in% c("University of Bary") ~ "UNIBA",
      Institute %in% c("Local Health Care Unit Fier, Institute of Public Health Tirana") ~ "ISHP_FIE",
      Institute %in% c("Local Health Care Unit Vlore, IInstitute of Public Health Tirana") ~ "ISHP_VLO",
      Institute %in% c("Istituto Zooprofilattico Sperimentale della Sicilia") ~ "IZSSI",
      Institute %in% c("Fondazione Museo Civico di Rovereto") ~ "MCR",
      TRUE ~ NA_character_  # default for others
    )
  ) |>
  pull(institutionCode)

# eventRemarks
eventRemarks <- data |>
  transmute(
    eventRemarks = case_when(
      Country == "Italy" & Institute == "University of Bary" ~
        paste("BPC, tap", substrate, larvicide_type, sep = ", "),
      Country == "Italy" & Institute == "Fondazione Museo Civico di Rovereto" ~
        paste("polypropylene", substrate, larvicide_type, sep = ", "),
      Country == "Italy" & Institute == "MUSE - Museo delle Scienze" ~
        paste("BPC", substrate, larvicide_type, sep = ", "),
      Country == "Italy" & Institute == "Emilia-Romagna Region" ~
        paste("BCPJ, dechlorinated", substrate, larvicide_type, sep = ", "),
      Country == "Italy" & Institute == "Istituto Zooprofilattico Sperimentale Lazio-Toscana" ~
        paste("BPC, tap, urban", substrate, larvicide_type, sep = ", "),
      Country == "Italy" & Institute == "Istituto Zooprofilattico Sperimentale della Sicilia" ~
        paste("BPC", substrate, larvicide_type, sep = ", "),
      Country == "Italy" & Institute == "Istituto Zooprofilattico Sperimentale delle Venezie" ~
        paste("BPC, tap, urban", substrate, larvicide_type, sep = ", "),
      Country == "Switzerland" & Institute == "SUPSI-DACD-IM-ECOVET" ~
        paste("BPC, tap", substrate, larvicide_type, sep = ", "),
      Country == "France" & Institute == "EID Mediterranee" ~
        paste("BPC", substrate, larvicide_type, sep = ", "),
      Country == "Albania" & Institute == "Local Health Care Unit Fier, Institute of Public Health Tirana" ~
        paste("BPC", substrate, larvicide_type, sep = ", "),
      Country == "Albania" & Institute == "Local Health Care Unit Vlore, Institute of Public Health Tirana" ~
        paste("BPC", substrate, larvicide_type, sep = ", "),
      Country == "Albania" & Institute == "Institute of Public Health Tirana" ~
        paste("BPC", substrate, larvicide_type, sep = ", "),
      TRUE ~ NA_character_
    )
  ) |>
  pull(eventRemarks)
```

## Creating a new dataframe
Create the new columns. Ensure consistent data types and formats, such as dates in YYYY-MM-DD format, and categorical values following controlled vocabularies.
```{r paged.print=TRUE}
# Create a new dataframe following DwC.
dwc_event <- data  |> 
  transmute(
    eventID = eventID,
    eventDate = eventDate,
    year = year,
    month = month,
    samplingProtocol = samplingProtocol,
    samplingSizeUnit   = samplingSizeUnit,
    samplingSizeValue  = samplingSizeValue,
    countryCode = countrycode(countryCode, "country.name.en", "iso2c"),
    samplingEffort = samplingEffort,
    decimalLatitude = decimalLatitude,
    decimalLongitude = decimalLongitude,
    geodeticDatum = geodeticDatum,
    coordinatePrecision = coordinatePrecision,
    footprintWKT = footprintWKT,
    habitat = habitat,
    continent = continent,
    country = country,
    stateProvince = stateProvince,
    municipality = municipality,
    institutionCode = institutionCode,
    eventRemarks = eventRemarks)
print(dwc_event)

# Save as .csv file
write.csv(
  dwc_event,
  file = paste0(datasetName, "_event.csv")
)
```

# Occurrence: Transforming datasets to occurrence DarwinCore format
*Required DwC fields:*

- occurrenceID
- basisOfRecord
- scientificName
- eventDate

*Strongly recommended DwC fields:*

- countryCode
- taxonRank
- kingdom
- decimalLatitude
- decimalLongitude
- geodeticDatum
- coordinateUncertaintyInMeters	 
- individualCount
- organismQuantity
- organismQuantityType

*Fields to be shared if available:*

- informationWithheld
- dataGeneralizations
- eventTime
- country

Selected fields will be included in the occurrence dataset in combination with other additional fields:

- occurrenceID: generally different from eventID (multiple occurrenceID for 1 eventID); in this case, they are similar (only 1 occurrence for 1 event)
- eventDate
- basisOfRecord
- taxonRank: to what level the organism was identified
- scientificName: should be provided according to a standard nomenclature
- nameAccordingTo: source or basis of scientificName
- genericName: informal name
- countryCode
- decimalLatitude 
- decimalLongitude
- geodeticDatum
- coordinatePrecision
- footprintWKT
- individualCount
- organismQuantity
- organismQuantityType
- lifeStage
- occurrenceRemarks

## Data review
Inspect the original dataset to ensure the presence and completeness of the fields required by the DwC standard.

## Column mapping and assignment
Identify the columns in the original dataset corresponding to each DwC field. Create objects in preparation for the new columns in the new dataframe, assigning values from the original dataset to the corresponding DwC fields. Ideally, we will only alter the contents of this section of the script and run the next section as is.
```{r paged.print=TRUE}
# occurrenceID
occurrenceID <- data$ID

# eventDate - previously given

# basisOfRecord
basisOfRecord <- data |> 
  transmute(
    basisOfRecord = case_when(
      trap_type %in% c("ovitrap") ~ "HumanObservation",
      TRUE ~ NA_character_ 
    )
  ) |> 
  pull(basisOfRecord)
  
# taxonRank
taxonRank <- data |> 
  transmute(
    taxonRank = case_when(
      !is.na(species) & species != "" ~ "species",
      !is.na(genus)   & genus   != "" ~ "genus",
      !is.na(family)  & family  != "" ~ "family",
      !is.na(order)   & order   != "" ~ "order",
      !is.na(class)   & class   != "" ~ "class",
      !is.na(phylum)  & phylum  != "" ~ "phylum",
      !is.na(kingdom) & kingdom != "" ~ "kingdom",
      TRUE ~ NA_character_
    )
  ) |> 
  pull(taxonRank)

# scientificName
scientificName <- "Aedes albopictus (Skuse, 1895)"

# nameAccordingTo
nameAccordingTo <- "Integrated Taxonomic Information System, https://www.itis.gov/, accessed on 9 january 2025"

# genericName
genericName <- paste(data$genus, data$species, sep = " ")

# countryCode - previously given
# decimalLatitude - previously given
# decimalLongitude - previously given
# geodeticDatum - previously given
# coordinatePrecision - previously given
# footprintWKT - previously given

# individualCount
individualCount <- data$value

# organismQuantity
organismQuantity <- data$value

# organismQuantityType
organismQuantityType <- ifelse(
  !is.na(data$value) & data$value != "",
  "individuals",
  NA_character_
)

# lifeStage
lifeStage <- data$life_stage

# occurrenceRemarks
occurrenceRemarks <- ifelse(
  is.na(data$value),
  "dry/overturned ovitrap; masonite stick not considered",
  NA_character_
)
```

## Creating a new dataframe
Create the new columns. Ensure consistent data types and formats, such as dates in YYYY-MM-DD format, and categorical values following controlled vocabularies.
```{r paged.print=TRUE}
# Create a new dataframe following DwC.
dwc_occurrence <- data  |> 
  transmute(
    occurrenceID = occurrenceID,
    eventDate = eventDate,
    basisOfRecord = basisOfRecord,
    taxonRank = taxonRank,
    scientificName = scientificName,
    nameAccordingTo = nameAccordingTo,
    genericName = genericName,
    countryCode = countrycode(countryCode, "country.name.en", "iso2c"),
    decimalLatitude = decimalLatitude,
    decimalLongitude = decimalLongitude,
    geodeticDatum = geodeticDatum,
    coordinatePrecision = coordinatePrecision,
    footprintWKT = footprintWKT,
    individualCount = individualCount,
    organismQuantity = organismQuantity,
    organismQuantityType = organismQuantityType,
    lifeStage = lifeStage,
    occurrenceRemarks = occurrenceRemarks)
print(dwc_occurrence)

# Save as .csv file
write.csv(
  dwc_occurrence,
  file = paste0(datasetName, "_occurrence.csv")
)
```

# Record-level: Transforming datasets to record-level metadataset DarwinCore format
*DwC fields:*

- type
- modified
- language
- license
- rightsHolder
- accessRights
- bibliographicCitation
- references
- feedbackURL
- institutionID
- collectionID
- datasetID
- institutionCode
- collectionCode
- datasetName
- ownerInstitutionCode
- basisOfRecord
- informationWithheld
- dataGeneralizations
- dynamicProperties

From the dataset and accompanying journal article (https://doi.org/10.1038/s41597-024-03482-y), we will try to extract information and compile into a record-level metadataset. Only fields above that have the available data will be included.

## Data review
Inspect the original dataset to ensure the presence and completeness of the fields required by the DwC standard.

## Column mapping and assignment

```{r}
# type
type <- "Dataset"

# modified
modified <- 2024-09-24

# language
language <- "en"

# license
license <- "http://creativecommons.org/licenses/by/4.0/"

# rightsHolder

# accessRights
accessRights <- "https://www.nature.com/articles/s41597-024-03482-y#additional-information:~:text=Reprints%20and%20permissions"

# bibliographicCitation
bibliographicCitation <- "Daniele Da Re. (2024). VectAbundace v0.1.5 [Data set]. Zenodo. https://doi.org/10.5281/zenodo.11486198"

# references
references <- "https://doi.org/10.1038/s41597-024-03482-y"

# feedbackURL
feedbackURL <- data$DOI_website

# institutionID
institutionID <- data$Institute

# collectionID

# datasetID - user-defined
datasetID <- "Ae_albo_VA2024"

# institutionCode - previously given

# collectionCode

# datasetName
datasetName <- "VectAbundance_2024"

# ownerInstitutionCode

# basisOfRecord - previously given

# informationWithheld
informationWithheld <- "Not raw records, post-processed"

# dataGeneralizations
dataGeneralizations <- "Downscaled to 1 week, Aggregated coordinates to center point of 9x9km grid"

# dynamicProperties
dynamicProperties <- NA
```

## Creating a new dataframe

```{r}
# Create a new dataframe binding all fields
dwc_metadata <- data  |> 
  transmute(
    datasetID = datasetID,
    datasetName = datasetName,
    type = type,
    modified = as.Date(modified, format = "%d/%m/%Y"),
    language = language,
    license = license,
    accessRights = accessRights,
    bibliographicCitation = bibliographicCitation,
    references = references,
    feedbackURL = feedbackURL,
    institutionID = institutionID,
    institutionCode = institutionCode,
    basisOfRecord = basisOfRecord,
    informationWithheld = informationWithheld,
    dataGeneralizations = dataGeneralizations,
    dynamicProperties = dynamicProperties)

print(dwc_metadata)

# Save as .csv file
write.csv(
  dwc_metadata,
  file = paste0(datasetName, "_metadata.csv")
)
```


